# Helix 语言服务器与语言配置
# https://docs.helix-editor.com/language-configuration.html
# 参考: https://github.com/helix-editor/helix/blob/master/languages.toml

# ==================== 语法高亮 Grammar ====================
# [use-grammars]
# only = []  # 只加载指定语言 grammar

# ==================== AI 语言服务器 ====================
# lsp-ai: https://github.com/SilasMarvin/lsp-ai
# llm-lsp: https://github.com/rosarp/llm-lsp
# helix-gpt: https://github.com/leona/helix-gpt

# Ollama + lsp-ai
# [language-server.lsp-ai]
# command = "lsp-ai"
# args = ["--config", "/path/to/config.json"]

# llm-lsp (支持 Codeium)
# [language-server.lsp-ai]
# command = "llm-lsp"
# args = ["server", "-p", "codeium"]

# helix-gpt (支持 Ollama)
# [language-server.lsp-ai]
# command = "helix-gpt"
# args = ["--handler", "ollama", "--ollamaModel", "qwen2.5-coder"]

# ==================== Snippets LSP ====================
# hx-lsp: https://github.com/erasin/hx-lsp
# 提供 snippets 和 action 功能
[language-server.hx-lsp]
command = "hx-lsp"

# ==================== 拼写检查 ====================
# Harper: https://github.com/Automattic/harper
# https://writewithharper.com/docs/integrations/language-server#Dictionaries
[language-server.harper-ls.config.harper-ls]
# diagnosticSeverity = "warning"
linters = { spaces = false }

# ==================== Rust ====================
[language-server.rust-analyzer.config]
inlayHints.bindingModeHints.enable = false
inlayHints.closingBraceHints.minLines = 10
inlayHints.closureReturnTypeHints.enable = "with_block"
inlayHints.discriminantHints.enable = "fieldless"
inlayHints.lifetimeElisionHints.enable = "skip_trivial"
inlayHints.typeHints.hideClosureInitialization = false
cargo.features = "all"                 # 启用所有 Cargo features
check.command = "clippy"                # 使用 clippy 检查

[[language]]
name = "rust"
language-servers = ["rust-analyzer", "hx-lsp", "harper-ls"]

# Rust 调试器配置
[language.debugger]
name = "lldb-dap"
transport = "stdio"
command = "lldb-vscode"

[[language.debugger.templates]]
name = "binary"
request = "launch"
completion = [{ name = "binary", completion = "filename" }]
args = { program = "{0}", initCommands = [
  "command script import /home/erasin/.config/helix/scripts/lldb_vscode_rustc_primer.py",
] }

# ==================== Go ====================
[[language]]
name = "go"
language-servers = [
  "gopls",
  "golangci-lint-lsp",
  "hx-lsp",
  "harper-ls",
  "lsp-ai",
]

# Go 代码提示配置
[language-server.gopls.config.hints]
assignVariableTypes = true
compositeLiteralFields = true
compositeLiteralTypes = true
constantValues = true
functionTypeParameters = true
ignoredError = true
parameterNames = true
rangeVariableTypes = true

# ==================== Godot 4 / GDScript ====================
[language-server.godot]
command = "nc"
args = ["127.0.0.1", "6005"]

[[language]]
name = "gdscript"
language-servers = ["godot", "hx-lsp", "harper-ls", "lsp-ai"]

# GDScript 调试器
[language.debugger]
name = "lldb-vscode"
transport = "stdio"
command = "lldb-vscode"

# GDB Server 附加调试
[[language.debugger.templates]]
name = "gdbserver attach"
request = "attach"
completion = [
  { name = "lldb connect url", default = "connect://127.0.0.1:6007" },
  { name = "file", completion = "filename" },
  "pid",
]
args = { attachCommands = [
  "platform select remote-gdb-server",
  "platform connect {0}",
  "file {1}",
  "attach {2}",
] }

# Godot 资源文件
[[language]]
name = "godot-resource"
scope = "source.tscn"
file-types = ["tscn", "tres", "godot", "gdextension", "import"]

# ==================== GDShader ====================
[[language]]
name = "gdshader"
scope = "source.gdshader"
injection-regex = "gdshader"
file-types = ["shader", "gdshader", "gdshaderinc"]
shebangs = []
roots = ["project.godot"]
auto-format = true
comment-token = "//"
block-comment-tokens = { start = "/*", end = "*/" }
indent = { tab-width = 4, unit = "\t" }
# language-servers = ["gdshader-lsp", "hx-lsp", "harper-ls"]

# GDShader 自定义 Grammar
[[grammar]]
name = "gdshader"
source = { git = "https://github.com/GodOfAvacyn/tree-sitter-gdshader", rev = "ffd9f958df13cae04593781d7d2562295a872455" }

# [language-server.gdshader-lsp]
# command = "gdshader-lsp"

# ==================== Web 开发 ====================

# Biome: https://biomejs.dev (格式化/检查)
[language-server.biome]
command = "biome"
args = ["lsp-proxy"]

# Emmet: HTML/CSS 缩写扩展
[language-server.emmet-language-server]
command = "emmet-ls"
args = ["--stdio"]

# TailwindCSS: https://tailwindcss.com
[language-server.tailwindcss-ls]
# command = "hx-tw"  # 替代方案
command = "tailwindcss-language-server"
args = ["--stdio"]

[language-server.tailwindcss-ls.config]
userLanguages = { rust = "html", "*.rs" = "html" }

[language-server.tailwindcss-ls.config.tailwindCSS.experimental]
classRegex = [
  # Dioxus 支持
  ["class: \"(.*)\""],
]

# ==================== TypeScript / JavaScript ====================
[language-server.typescript-language-server.config]
hostInfo = "helix"
locale = "zh-CN"

[language-server.typescript-language-server.config.typescript.inlayHints]
includeInlayEnumMemberValueHints = true
includeInlayFunctionLikeReturnTypeHints = false
includeInlayFunctionParameterTypeHints = true
includeInlayParameterNameHints = "all"
includeInlayParameterNameHintsWhenArgumentMatchesName = false
includeInlayPropertyDeclarationTypeHints = true
includeInlayVariableTypeHints = true

[language-server.typescript-language-server.config.javascript.inlayHints]
includeInlayEnumMemberValueHints = true
includeInlayFunctionLikeReturnTypeHints = false
includeInlayFunctionParameterTypeHints = true
includeInlayParameterNameHints = "all"
includeInlayParameterNameHintsWhenArgumentMatchesName = false
includeInlayPropertyDeclarationTypeHints = true
includeInlayVariableTypeHints = true

# Svelte
[[language]]
name = "svelte"
roots = ["package.json"]
language-servers = ["svelteserver", "tailwindcss-ls", "hx-lsp"]

# SCSS
[[language]]
name = "scss"
file-types = ["scss"]

# CSS
[[language]]
name = "css"
file-types = ["css"]
language-servers = [
  "vscode-css-language-server",
  "biome",
  "emmet-language-server",
  "tailwindcss-ls",
]

# JSON
[[language]]
name = "json"
language-servers = [
  { name = "vscode-json-language-server", except-features = ["format"] },
  "biome",
  "hx-lsp",
]

# JSONC / TSConfig
[[language]]
name = "jsonc"
file-types = [
  "jsonc",
  "code-snippets",
  { glob = "tsconfig.json" },
  { glob = "bun.lock" },
]
language-servers = [
  { name = "vscode-json-language-server", except-features = ["format"] },
  "biome",
  { name = "hx-lsp", only-features = ["document-colors"] },
]

# HTML
[[language]]
name = "html"
file-types = ["html", "xhtml"]
language-servers = [
  "vscode-html-language-server",
  "emmet-language-server",
  "tailwindcss-ls",
  "hx-lsp",
  "harper-ls",
  "lsp-ai",
]

# XML
[[language]]
name = "xml"
language-servers = ["vscode-html-language-server"]

# Vue
[[language]]
name = "vue"
language-servers = ["vuels", "tailwindcss-ls", "hx-lsp", "harper-ls", "lsp-ai"]

# TSX
[[language]]
name = "tsx"
language-servers = [
  { name = "typescript-language-server", except-features = ["format"] },
  "biome",
  "tailwindcss-ls",
  "hx-lsp",
  "harper-ls",
  "lsp-ai",
]

# JSX
[[language]]
name = "jsx"
language-servers = [
  { name = "typescript-language-server", except-features = ["format"] },
  "biome",
  "tailwindcss-ls",
  "hx-lsp",
  "harper-ls",
  "lsp-ai",
]

# JavaScript
[[grammar]]
name = "jsdoc"
source = { git = "https://github.com/tree-sitter/tree-sitter-jsdoc", rev = "49fde205b59a1d9792efc21ee0b6d50bbd35ff14" }

[[language]]
name = "javascript"
auto-format = true
language-servers = [
  { name = "typescript-language-server", except-features = ["format"] },
  "biome",
  "hx-lsp",
  "harper-ls",
  "lsp-ai",
]

# TypeScript
[[language]]
name = "typescript"
auto-format = true
language-servers = [
  { name = "typescript-language-server", except-features = ["format"] },
  "biome",
  "hx-lsp",
  "lsp-ai",
]

# ==================== YAML ====================
[[language]]
name = "yaml"
formatter = { command = 'prettier', args = ["--parser", "yaml"] }
language-servers = ["hx-lsp"]

# ==================== PHP ====================
[language-server.intelephense.config]
licenceKey = "/home/erasin/dotfile/tokens/intelephenser"
globalStoragePath = "/home/erasin/.config/php/"

[language-server.intelephense.config.intelephense]
# stubs = ["redis"]
includePaths = ["/home/erasin/.config/php/stubs/"]

[[language]]
name = "php"
language-servers = ["intelephense", "hx-lsp"]

# PHP Xdebug 调试器
[language.debugger]
name = "php-xdebug-dap"
transport = "stdio"
command = "/home/erasin/Development/project/php-dap/target/debug/php-dap"

[[language.debugger.templates]]
name = "Listen for Xdebug"
request = "launch"
args = {}

# ==================== Python ====================
# Pyright: https://github.com/microsoft/pyright
[language-server.pyright]
command = "pyright-langserver"
args = ["--stdio"]
# 禁用 diagnostics/format，使用 ruff-lsp
except-features = ["diagnostics", "format"]

[language-server.pyright.config]
# 配置参考: pyproject.toml [tool.pyright]
settings.python.analysis = {
  autoImportCompletions = true,
  typeCheckingMode = "on",
  autoSearchPaths = true,
  useLibraryCodeForTypes = true,
  diagnosticMode = "openFilesOnly"
}

# Pylsp (可选)
[language-server.pylsp.config]
pylsp.plugins.rope_autoimport.enabled = true

# Pylyzer: https://github.com/mtshiba/pylyzer
[language-server.pylyzer]
command = "pylyzer"
args = ["--server"]

# Ruff: https://docs.astral.sh/ruff
[language-server.ruff-lsp]
command = "ruff"
args = ["server"]

[[language]]
name = "python"
file-types = ["py", "pyi", "py3", "pyw", "ptl", ".pythonstartup", ".pythonrc", "SConstruct", "mel"]
roots = ["pyproject.toml", "pyrightconfig.json", "ty.toml"]
# formatter = { command = "ruff", args = ["format"] }
language-servers = ["ty", "ruff-lsp", "hx-lsp", "lsp-ai"]
auto-format = true

# ==================== Lua ====================
[[language]]
name = "lua"
language-servers = ["lua-language-server", "lsp-ai"]

[language-server.lua-language-server]
args = ["--locale", "zh-cn"]

# 配置参考: .luarc.json
[language-server.lua-language-server.config.Lua.hint]
enable = true
arrayIndex = "Enable"
setType = true
paramName = "All"
paramType = true
await = true

[language-server.lua-language-server.config.Lua.runtime]
nonstandardSymbol = ["+=", "-=", "*=", "/=", "//=", "%=", "<<=", ">>=", "&=", "|=", "^="]
special = { "import" = "require" }

# 自定义 Lua Grammar (支持更多语法)
[[grammar]]
name = "lua"
source = { git = "https://github.com/erasin/tree-sitter-lua", rev = "0158ad30769a3fcf7f40dcaaa94509023ff7fea6" }

# ==================== Git ====================
[[language]]
name = "git-commit"
soft-wrap = { enable = true, wrap-at-text-width = true }

# ==================== INI ====================
[[language]]
name = "ini"
scope = "source.ini"
file-types = [
  "ini",
  # Systemd unit files
  "service", "automount", "device", "mount", "path", "socket", "swap", "target", "timer", "slice",
  # Podman quadlets
  "container", "volume", "kube", "network",
  { glob = ".editorconfig" },
  { glob = "rclone.conf" },
  "properties", "cfg", "directory", "desktop",
]

# ==================== Markdown ====================
# IWE: https://github.com/iwe-org/iwe
[language-server.iwe]
command = "iwes"

# Markdown 配置
[[language]]
name = "markdown"
formatter = { command = "prettier", args = ["--parser", "markdown"] }
language-servers = [
  "markdown-oxide",
  "hx-lsp",
  "harper-ls",
]
# auto-format = true
# text-width = 80
# soft-wrap = { enable = true, wrap-at-text-width = true }

# ==================== LaTeX ====================
[[language]]
name = "latex"
language-servers = ["texlab", "hx-lsp"]

# ==================== Typst ====================
# 参考: https://myriad-dreamin.github.io/tinymist//frontend/helix.html
[[language]]
name = "typst"
language-servers = ["tinymist", "hx-lsp"]
formatter = { command = "typst", args = ["c"] }
text-width = 80
soft-wrap = { enable = true, wrap-at-text-width = true }

# ==================== Glicol ====================
# https://github.com/TenStrings/glicol-lsp
[language-server.glicol-lsp]
command = "glicol-lsp"

[[language]]
name = "glicol"
scope = "source.glicol"
injection-regex = "glicol"
file-types = ["glicol"]
comment-token = "//"
indent = { tab-width = 4, unit = "\t" }
language-servers = ["glicol-lsp"]

[[grammar]]
name = "glicol"
source = { git = "https://github.com/TenStrings/tree-sitter-glicol", rev = "da7b171e87462afa6c74ad772742ec485f821072" }

# ==================== Beancount ====================
[language-server.beancount-lsp]
command = "beancount-language-server"
args = ["--stdio"]
config.journal_file = "~/.cache/beancount.log"

[[language]]
name = "beancount"
language-servers = ["beancount-lsp", "hx-lsp"]

[[grammar]]
name = "beancount"
source = { git = "https://github.com/polarmutex/tree-sitter-beancount", rev = "9bc460a05b5f096d69568b5fb36105032ff4ff97" }

# ==================== Fluent ====================
[[language]]
name = "fluent"
scope = "source.ftl"
injection-regex = "fluent"
file-types = ["ftl"]
comment-token = "#"
indent = { tab-width = 4, unit = "    " }

[[grammar]]
name = "fluent"
source = { git = "https://github.com/erasin/tree-sitter-fluent", rev = "14ad08028c0287ca8c10ce620377f581e17dddb2" }

# ==================== HTTP ====================
[[language]]
name = "http"
scope = "source.http"
injection-regex = "http"
file-types = ["rest", "http"]
comment-token = "#"
indent = { tab-width = 4, unit = "    " }

[[grammar]]
name = "http"
source = { git = "https://github.com/rest-nvim/tree-sitter-http", rev = "e061995f0caf2fa30f68fa1fdf2c08bcbd4629a8" }

# ==================== Ron ====================
[[language]]
name = "ron"
file-types = ["ron", "trickfilm"]
formatter = { command = 'ronfmt', args = ["%{buffer_name}"] }

# ==================== Scheme ====================
[language-server.steel]
command = "steel-language-server"

[[language]]
name = "scheme"
shebangs = ["scheme", "guile", "chicken", "steel"]
language-servers = ["steel", "hx-lsp"]

# ==================== Dart ====================
[language-server.dart.config]
closingLabels = true
outline = true
flutterOutline = true
allowOpenUri = true

[[language]]
name = "dart"
language-servers = ["dart", "lsp-ai", "hx-lsp"]

# ==================== KDL ====================
[[language]]
name = "kdl"
language-servers = [{ name = "hx-lsp", only-features = ["document-colors"] }]

[[grammar]]
name = "kdl"
source = { git = "https://github.com/tree-sitter-grammars/tree-sitter-kdl", rev = "b37e3d58e5c5cf8d739b315d6114e02d42e66664" }

# ==================== TOML ====================
[language-server.taplo]
config = {}

[[language]]
name = "toml"
language-servers = [
  "taplo",
  { name = "hx-lsp", only-features = ["document-colors"] },
]
formatter = { command = "taplo", args = ["fmt", "-"] }

# ==================== Hurl ====================
[[language]]
name = "hurl"
language-servers = ["hx-lsp"]

[[grammar]]
name = "hurl"
source = { git = "https://github.com/pfeiferj/tree-sitter-hurl", rev = "597efbd7ce9a814bb058f48eabd055b1d1e12145" }

# ==================== Shader (Wgsl/Wesl) ====================
# Shader Language Server
[language-server.shader-language-server]
command = "shader-language-server"

[[language]]
name = "wgsl"
language-servers = ["wgsl-analyzer", "hx-lsp"]

[[language]]
name = "wesl"
language-servers = ["wgsl-analyzer", "hx-lsp"]

# ==================== Cangjie ====================
[[language]]
name = "cangjie"
scope = "source.cangjie"
injection-regex = "cangjie"
file-types = ["cj"]
roots = []
auto-format = false
comment-token = "//"
block-comment-tokens = { start = "/*", end = "*/" }
indent = { tab-width = 4, unit = "    " }

[[grammar]]
name = "cangjie"
source = { git = "https://gitcode.com/vchuoshen6/tree-sitter-cangjie", rev = "4a47b8790c88f079c8adfc6fa5c6cb2e536998d1" }

# ==================== Env ====================
[[language]]
name = "env"
file-types = [
  "env",
  { glob = ".env" },
  { glob = ".env.*" },
  { glob = ".envrc" },
  { glob = ".envrc.*" },
]

# ==================== Hexdump ====================
[[language]]
name = "hexdump"
scope = "source.hexdump"
injection-regex = "hexdump"
file-types = ["hexdump"]
roots = []
auto-format = false
comment-token = "#"
indent = { tab-width = 2, unit = "  " }

[[grammar]]
name = "hexdump"
source = { git = "https://github.com/rush-rs/tree-sitter-hexdump", rev = "09eaf4fcfed00be93928d7d3d82b490cd1343b80"}

# ==================== Ruby ====================
[[language]]
name = "ruby"
language-servers = ["ruby-lsp", "solargraph", "hx-lsp"]

# ==================== Goctl ====================
[[language]]
name = "goctl"
scope = "source.goctl"
injection-regex = "goctl"
file-types = ["goctl", "api"]
roots = []
auto-format = false
comment-token = "//"
block-comment-tokens = { start = "/*", end = "*/" }
indent = { tab-width = 4, unit = "    " }

[[grammar]]
name = "goctl"
source = { git = "https://github.com/chaoswn/tree-sitter-goctl", rev = "49c43532689fe1f53e8b9e009d0521cab02c432b"}

# ==================== 模板语言 (已禁用) ====================
# [[language]]
# name = "tpl5"
# scope = "source.tpl5"
# injection-regex = "tpl5"
# file-types = ["tpl5", { glob = "views/*.thml" }]
# comment-token = "{//"
# block-comment-tokens = { start = "{/*", end = "*/}" }
# indent = { tab-width = 2, unit = "  " }

# [[grammar]]
# name = "tpl5"
# source = { git = "https://github.com/erasin/tree-sitter-tpl5", rev = "185cef710b24211f8fe45455ad47e2e653dd224e" }
